<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Peta NPK Demo — Esri Imagery Only (Upscale Last Tile)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

  <script>
    // ======== GANTI DENGAN CONFIG FIREBASE ANDA ========
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyBfkTfceiBKwG8rNhKF5AmYCr9juvORrR8",
      authDomain: "esp-npk-gp.firebaseapp.com",
      databaseURL: "https://esp-npk-gp-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "esp-npk-gp",
      storageBucket: "esp-npk-gp.firebasestorage.app",
      messagingSenderId: "159159492837",
      appId: "1:159159492837:web:24defd5d667e22354f340c"
    };
    // ===================================================

    // Init Firebase
    firebase.initializeApp(FIREBASE_CONFIG);
    const db = firebase.database();

    // Map init
    const map = L.map('map', {
      center: [-8.6530, 116.3440],
      zoom: 16,
      zoomControl: true
    });

    // Transparent 1x1 PNG to avoid Esri "not available" tiles showing
    const transparentPng = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8Xw8AAn8B+G3mC1QAAAAASUVORK5CYII=';

    // Esri World Imagery — upscale last available tile beyond native zoom
    const esriSat = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        // Set native max for your area; try 18 if 19 still shows warnings
        maxNativeZoom: 19,
        maxZoom: 22,             // allow zooming in further (digital upscale)
        errorTileUrl: transparentPng,
        noWrap: true,
        attribution: 'Tiles © Esri — Esri, Maxar, Earthstar Geographics'
    }).addTo(map);

    // (Optional) enforce map max zoom too
    map.setMaxZoom(22);

    // Marker store
    const markers = {}; // key = device_ts

    function npkColor(n) {
      if (n >= 1.2) return '#2ecc71'; // green
      if (n >= 0.8) return '#f39c12'; // orange
      return '#e74c3c';               // red
    }

    function addOrUpdateMarker(device, ts, entry) {
      const key = device + '_' + ts;
      if (!entry || typeof entry.lat !== 'number' || typeof entry.lon !== 'number') return;

      if (markers[key]) {
        markers[key].setLatLng([entry.lat, entry.lon]);
        return;
      }

      const color = npkColor(Number(entry.n || 0));
      const marker = L.circleMarker([entry.lat, entry.lon], {
        radius: 8, weight: 1, fillOpacity: 0.9, fillColor: color, color: '#000'
      }).addTo(map);

      const popup = `<b>Device:</b> ${entry.device_id || device}<br/>
        <b>Lat, Lon:</b> ${entry.lat}, ${entry.lon}<br/>
        <b>N:</b> ${entry.n ?? '-'} &nbsp; <b>P:</b> ${entry.p ?? '-'} &nbsp; <b>K:</b> ${entry.k ?? '-'}<br/>
        <b>Accuracy:</b> ${entry.accuracy ?? '-'} m<br/>
        <b>TS:</b> ${new Date(entry.ts || Number(ts)).toLocaleString()}`;

      marker.bindPopup(popup);
      markers[key] = marker;
    }

    // Realtime listener
    const locRef = db.ref('/locations');
    locRef.on('value', (snapshot) => {
      const data = snapshot.val();
      if (!data) return;
      for (const device in data) {
        const entries = data[device];
        for (const ts in entries) {
          addOrUpdateMarker(device, ts, entries[ts]);
        }
      }
      // Auto-fit after initial load
      setTimeout(() => {
        const layerList = Object.values(markers);
        if (layerList.length > 0) {
          const group = L.featureGroup(layerList);
          map.fitBounds(group.getBounds().pad(0.2));
        }
      }, 500);
    });
  </script>
</body>
</html>
